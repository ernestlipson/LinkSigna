rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - unified collection for students and interpreters
    // Role-based access control with role field ('student' or 'interpreter')
    match /users/{userId} {
      // Allow any authenticated user to read user profiles
      // This enables students to view interpreter profiles and vice versa
      allow read: if request.auth != null;
      
      // Allow users to update only their own profile
      // Prevent changing authUid or role after creation
      allow update: if request.auth != null 
        && resource.data.authUid == request.auth.uid
        && request.resource.data.authUid == resource.data.authUid
        && request.resource.data.role == resource.data.role;
      
      // Allow users to create their own profile
      // Must match authenticated UID and provide required fields
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.authUid
        && request.resource.data.role in ['student', 'interpreter']
        && request.resource.data.email is string;
      
      // Allow users to delete only their own profile
      allow delete: if request.auth != null && resource.data.authUid == request.auth.uid;
    }
    
    // Sessions collection - allow authenticated students or interpreters access
    match /sessions/{sessionId} {
      // Function to check if user is a participant in the session
      function isSessionParticipant() {
        let session = resource.data;
        let studentDoc = get(/databases/$(database)/documents/users/$(session.studentId));
        let interpreterDoc = get(/databases/$(database)/documents/users/$(session.interpreterId));
        
        return request.auth.uid == studentDoc.data.authUid 
            || request.auth.uid == interpreterDoc.data.authUid;
      }
      
      // Allow read/write if user is participant
      allow read, write: if request.auth != null && isSessionParticipant();

      // Allow create if the caller is either the student or interpreter
      allow create: if request.auth != null && (
        request.auth.uid == get(/databases/$(database)/documents/users/$(request.resource.data.studentId)).data.authUid
        || request.auth.uid == get(/databases/$(database)/documents/users/$(request.resource.data.interpreterId)).data.authUid
      );
    }
    
    // DEPRECATED COLLECTIONS - Keep rules for backwards compatibility
    // These can be removed after full migration to unified users collection
    
    // Interpreters collection - DEPRECATED (use users collection instead)
    match /interpreters/{interpreterId} {
      allow get: if request.auth != null && resource.data.role == 'interpreter';
      allow list: if request.auth != null && resource.data.role == 'interpreter';
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.authUid
        && request.resource.data.role == 'interpreter'
        && request.resource.data.authUid is string
        && request.resource.data.email is string;
      allow update: if request.auth != null
        && resource.data.authUid == request.auth.uid
        && request.resource.data.authUid == resource.data.authUid
        && request.resource.data.role == resource.data.role;
      allow delete: if request.auth != null && resource.data.authUid == request.auth.uid;
    }
    
    // Students collection - DEPRECATED (use users collection instead)
    match /students/{studentId} {
      allow get: if request.auth != null && resource.data.authUid == request.auth.uid;
      allow list: if request.auth != null 
        && request.query.limit <= 10
        && resource.data.authUid == request.auth.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authUid;
      allow update: if request.auth != null
        && resource.data.authUid == request.auth.uid
        && request.resource.data.authUid == resource.data.authUid;
      allow delete: if request.auth != null && resource.data.authUid == request.auth.uid;
    }
  }
}
