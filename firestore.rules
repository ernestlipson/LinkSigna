rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - unified collection for students and interpreters
    // Role-based access control with role field ('student' or 'interpreter')
    match /users/{userId} {
      // Allow any authenticated user to read user profiles
      // This enables students to view interpreter profiles and vice versa
      allow read: if request.auth != null;
      
      // Allow users to update only their own profile
      // Prevent changing authUid or role after creation
      // Also allow any authenticated user to update interpreter ratings
      allow update: if request.auth != null && (
        resource.data.authUid == request.auth.uid ||
        resource.data.role == 'interpreter'
      );
      
      // Allow users to create their own profile
      // Must match authenticated UID and provide required fields
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.authUid
        && request.resource.data.role in ['student', 'interpreter']
        && request.resource.data.email is string;
      
      // Allow users to delete only their own profile
      allow delete: if request.auth != null && resource.data.authUid == request.auth.uid;
    }    // Bookings collection - secure booking approval system
    match /bookings/{bookingId} {
      // Allow students to create bookings
      // Validation: must have required fields and status must be 'pending'
      allow create: if request.auth != null 
        && request.resource.data.studentId is string
        && request.resource.data.interpreterId is string
        && request.resource.data.dateTime is timestamp
        && request.resource.data.status == 'pending'
        && request.resource.data.studentName is string
        && request.resource.data.interpreterName is string;
      
      // Allow any authenticated user to read bookings
      // This allows students to see their bookings and interpreters to see theirs
      allow read: if request.auth != null;
      
      // Allow any authenticated user to update booking status
      // Client-side code should verify ownership before allowing updates
      allow update: if request.auth != null;
      
      // Allow authenticated users to delete bookings
      allow delete: if request.auth != null;
      
      // Messages subcollection for chat feature
      match /messages/{messageId} {
        // Allow both student and interpreter in the booking to read messages
        allow read: if request.auth != null 
          && (get(/databases/$(database)/documents/bookings/$(bookingId)).data.studentId == request.auth.uid
           || get(/databases/$(database)/documents/bookings/$(bookingId)).data.interpreterId == request.auth.uid);
        
        // Allow both student and interpreter to create messages
        allow create: if request.auth != null
          && (get(/databases/$(database)/documents/bookings/$(bookingId)).data.studentId == request.auth.uid
           || get(/databases/$(database)/documents/bookings/$(bookingId)).data.interpreterId == request.auth.uid)
          && request.resource.data.senderId is string
          && request.resource.data.senderName is string
          && request.resource.data.senderRole in ['student', 'interpreter']
          && request.resource.data.message is string
          && request.resource.data.timestamp is timestamp;
        
        // Allow sender to update their own message (for read status)
        allow update: if request.auth != null;
        
        // Allow sender to delete their own message
        allow delete: if request.auth != null 
          && resource.data.senderId == request.auth.uid;
      }
    }
    
    // WebRTC signaling channels - for peer-to-peer video calls
    match /channels/{channelId} {
      // Allow any authenticated user to create a channel (offer)
      allow create: if request.auth != null;
      
      // Allow participants to read channel data (offer/answer)
      // Anyone can read to join the call
      allow read: if request.auth != null;
      
      // Allow any authenticated user to update channel (answer)
      allow update: if request.auth != null;
      
      // Allow creator to delete channel when call ends
      allow delete: if request.auth != null;
      
      // ICE candidates subcollection for WebRTC signaling
      match /candidates/{candidateId} {
        // Allow any authenticated user to add ICE candidates
        allow create: if request.auth != null;
        
        // Allow participants to read ICE candidates
        allow read: if request.auth != null;
        
        // Allow cleanup when call ends
        allow delete: if request.auth != null;
      }
    }
    
    // DEPRECATED COLLECTIONS - Keep rules for backwards compatibility
    // These can be removed after full migration to unified users collection
    
    // Interpreters collection - DEPRECATED (use users collection instead)
    match /interpreters/{interpreterId} {
      allow get: if request.auth != null && resource.data.role == 'interpreter';
      allow list: if request.auth != null && resource.data.role == 'interpreter';
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.authUid
        && request.resource.data.role == 'interpreter'
        && request.resource.data.authUid is string
        && request.resource.data.email is string;
      allow update: if request.auth != null
        && resource.data.authUid == request.auth.uid
        && request.resource.data.authUid == resource.data.authUid
        && request.resource.data.role == resource.data.role;
      allow delete: if request.auth != null && resource.data.authUid == request.auth.uid;
    }
    
    // Students collection - DEPRECATED (use users collection instead)
    match /students/{studentId} {
      allow get: if request.auth != null && resource.data.authUid == request.auth.uid;
      allow list: if request.auth != null 
        && request.query.limit <= 10
        && resource.data.authUid == request.auth.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authUid;
      allow update: if request.auth != null
        && resource.data.authUid == request.auth.uid
        && request.resource.data.authUid == resource.data.authUid;
      allow delete: if request.auth != null && resource.data.authUid == request.auth.uid;
    }
  }
}
